<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>กำลังพาไปตะกร้าและหน้าสั่งซื้อ…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ถ้าผู้ใช้ปิด JavaScript ให้พาไปหน้าสั่งซื้อโดยตรง -->
  <noscript>
    <meta http-equiv="refresh" content="0;url=https://tuowzz.github.io/github.io/">
  </noscript>
  <style>
    html,body{height:100%}
    body{margin:0;display:flex;align-items:center;justify-content:center;font-family:system-ui,-apple-system,"Kanit",Segoe UI,Roboto,Arial,sans-serif;color:#333;background:#fafafa}
    .wrap{text-align:center;padding:28px}
    .title{font-weight:700;font-size:1.1rem}
    .desc{font-size:.95rem;color:#666;margin-top:6px}
    .btn{display:inline-block;margin-top:16px;padding:12px 18px;border-radius:10px;background:#000;color:#fff;text-decoration:none;font-weight:700}
    .hint{font-size:.88rem;color:#888;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">กำลังพาไปตะกร้า TikTok และหน้าสั่งซื้อ…</div>
    <div class="desc">หากเบราว์เซอร์บล็อกการเปิดหน้าต่างอัตโนมัติ ให้กดปุ่มด้านล่าง</div>
    <a id="openBtn" class="btn" href="#" rel="noopener">เปิดตะกร้า TikTok</a>
    <div class="hint">ระบบจะพาคุณไปหน้าเว็บสั่งซื้ออัตโนมัติ</div>
  </div>

<script>
(function(){
  // ===== ปลายทาง =====
  var TIKTOK_URL = "https://vt.tiktok.com/ZSSH9A3F7";
  var SALES_URL  = "https://tuowzz.github.io/github.io/";

  // ===== คีย์พารามิเตอร์ที่ต้องการเก็บ =====
  var KEYS = ["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","fbclid","ttclid"];

  // ===== ดึงค่าจาก URL คลิกแรก =====
  var qs = new URLSearchParams(location.search);
  var data = {};
  KEYS.forEach(function(k){ var v = qs.get(k); if (v) data[k] = v; });
  data.referrer = document.referrer || "";

  // ===== เก็บเป็น Cookie (7 วัน) บนโดเมนเรา =====
  var expires = new Date(Date.now()+7*24*60*60*1000).toUTCString();
  Object.keys(data).forEach(function(k){
    document.cookie = encodeURIComponent(k)+"="+encodeURIComponent(data[k])
      + "; expires="+expires+"; path=/; samesite=lax";
  });

  // ===== เก็บสำรองใน localStorage (อ่านง่ายในหน้าสั่งซื้อ) =====
  try { localStorage.setItem("mb_attr", JSON.stringify({ ...data, ts: Date.now() })); } catch(e){}

  // ===== แนบ params กลับไปทั้งสองปลายทาง (กันกรณี cross-domain) =====
  function withParams(url){
    var p = new URLSearchParams();
    Object.keys(data).forEach(function(k){ if (data[k]) p.set(k, data[k]); });
    if (!p.toString()) return url;
    return url + (url.includes("?") ? "&" : "?") + p.toString();
  }
  var tikTokFinal = withParams(TIKTOK_URL);
  var salesFinal  = withParams(SALES_URL);

  // ===== เปิด TikTok ในแท็บใหม่ (ให้ TikTok ตั้งคุกกี้/อ่านพารามิเตอร์ของตัวเอง) แล้วพาแท็บเดิมไปหน้าเว็บสั่งซื้อ =====
  function goFlow(){
    // อาจถูกบล็อกถ้าไม่มี user gesture
    var win = window.open(tikTokFinal, "_blank", "noopener");
    // เปลี่ยนแท็บปัจจุบันไปยังหน้าเว็บสั่งซื้อ (ดีเลย์เล็กน้อยให้เบราว์เซอร์จัดการ UI)
    setTimeout(function(){ location.replace(salesFinal); }, 300);
    return !!win;
  }

  // พยายามทำงานอัตโนมัติ
  var opened = goFlow();

  // Fallback: ถ้าโดนบล็อก popup ให้ผู้ใช้กดปุ่ม
  var btn = document.getElementById("openBtn");
  btn.href = tikTokFinal;
  btn.addEventListener("click", function(e){
    e.preventDefault();
    goFlow();
  });
})();
</script>
</body>
</html>
